#!/usr/bin/env node
(()=>{var e={277:(e,n,t)=>{"use strict";t.r(n);const r=require("dotenv"),i=(require("sass"),require("fs-extra"));var o=t.n(i);const s=require("path");var l=t.n(s);const a=require("webpack");var d=t.n(a);const u=require("js-beautify"),c=require("terser-webpack-plugin"),p={minimize:!0,minimizer:[new(t.n(c)())({terserOptions:{module:!0,compress:{defaults:!1},mangle:!1,parse:{},rename:{},format:{comments:!1,max_line_len:!1,semicolons:!0,beautify:!0}}})]},f=JSON.parse('{"build":{"production":false,"watch":true},"discord":{"userId":"???","username":"???"},"github":{"username":"???","branchName":"???","repo":"???"},"paths":{"bdfolder":"???","release_folder":"???"}}');let m="",g={},y={};function h(e,n){for(const t of Object.keys(e))Array.isArray(n[t])&&Array.isArray(e[t])?e[t].push(...n[t]):Array.isArray(n[t])?e[t]=n[t]:"object"==typeof n[t]&&"object"==typeof e[t]?e[t]=h(e[t],n[t]):e[t]=n[t];return e}function b(e,n){return B(e)?n:e}function B(e){return void 0===e||Object.is(e,null)}function P(e,n,t="{{",r="}}"){for(const i in n)e=e.replace(new RegExp(`${t}${i}${r}`,"g"),n[i]);return e}function _(e){return l().resolve(l().join(__dirname,"..","node_modules",e))}function v(){const e=process.hrtime();return 1e9*e[0]+e[1]}function A(e=""){const n=o().readJSONSync(l().resolve(m,"package.json"));return e.split(".").reduce(((e,n)=>B(n)||B(e)?e:n?e[n]:e),n)}function M(){const e=function(){const e=l().join(process.cwd(),"bdbuilder.config.json");try{return t(79)(e)}catch(n){throw new Error("Could not resolve build config at "+e)}}();return h(f,e)}P.bind=e=>(e.format=Function.prototype.bind.call(P,e),e);const S={deepAssign:h,resolveType:function(e,n=!0){switch(e.toLowerCase()){case n&&"theme":case n&&"themes":return"themes";case!n&&"theme":case!n&&"themes":return"theme";case n&&"plugin":return"plugin";case n&&"plugins":return"plugins";case!n&&"plugin":case!n&&"plugins":return"plugin";default:throw new Error("Could not resolve "+e+" as addon type.")}},upperFirst:function(e){return e[0].toUpperCase()+e.slice(1)},nullish:b,formatString:P,format:P,resolveModule:_,nanoseconds:v,getAddonConfig:A,init:function(e,n){m=l().resolve(__dirname,"..",e),g=n},getPath:function(){return m},setBuiltConfig:function(e){y=e},getBuilderConfig:M,resolveRawGithub:function(e,n){return`https://raw.githubusercontent.com/${process.env.GITHUB_NAME}/${process.env.GITHUB_REPO}/${process.env.GITHUB_BRANCH}/${e}/${n}`},startTime:v(),get argv(){return g},get isRelease(){return b(g.release,M().build.release)},get shouldWatch(){return b(g.watch,M().build.watch)},get isDevelopment(){return b(this.isRelease,b(g.production,A("build.production")))}},w=JSON.parse('{"react-spring":"BdApi.findModuleByProps(\'useSpring\')","@discord/utils":{"joinClassNames":"BdApi.findModule(m => typeof m?.default?.default === \'function\')?.default","useForceUpdate":"BdApi.findModuleByProps(\'useForceUpdate\')?.useForceUpdate","Logger":"BdApi.findModuleByProps(\'setLogFn\')?.default","Navigation":"BdApi.findModuleByProps(\'replaceWith\')"},"@discord/components":{"Tooltip":"BdApi.findModuleByDisplayName(\'Tooltip\')","TooltipContainer":"BdApi.findModuleByProps(\'TooltipContainer\')?.TooltipContainer","TextInput":"BdApi.findModuleByDisplayName(\'TextInput\')","SlideIn":"BdApi.findModuleByDisplayName(\'SlideIn\')","SettingsNotice":"BdApi.findModuleByDisplayName(\'SettingsNotice\')","TransitionGroup":"BdApi.findModuleByDisplayName(\'TransitionGroup\')","Button":"BdApi.findModuleByProps(\'DropdownSizes\')","Flex":"BdApi.findModuleByDisplayName(\'Flex\')","Text":"BdApi.findModuleByDisplayName(\'Text\')","Card":"BdApi.findModuleByDisplayName(\'Card\')"},"@discord/modules":{"Dispatcher":"BdApi.findModuleByProps(\'dirtyDispatch\', \'subscribe\')","EmojiUtils":"BdApi.findModuleByProps(\'uploadEmoji\')","PermissionUtils":"BdApi.findModuleByProps(\'computePermissions\')","DMUtils":"BdApi.findModuleByProps(\'openPrivateChannel\')"},"@discord/stores":{"Messages":"BdApi.findModuleByProps(\'getMessage\', \'getMessages\')","Channels":"BdApi.findModuleByProps(\'getChannel\')","Guilds":"BdApi.findModuleByProps(\'getGuild\')","SelectedGuilds":"BdApi.findModuleByProps(\'getGuildId\', \'getLastSelectedGuildId\')","SelectedChannels":"BdApi.findModuleByProps(\'getChannelId\', \'getLastSelectedChannelId\')","Info":"BdApi.findModuleByProps(\'getSessionId\')","Status":"BdApi.findModuleByProps(\'getStatus\')","Users":"BdApi.findModuleByProps(\'getUser\')","SettingsStore":"BdApi.findModuleByProps(\'afkTimeout\', \'status\')","UserProfile":"BdApi.findModuleByProps(\'getUserProfile\')","Members":"BdApi.findModuleByProps(\'getMember\')","Activities":"BdApi.findModuleByProps(\'getActivities\')","Games":"BdApi.findModuleByProps(\'getGame\')","Auth":"BdApi.findModuleByProps(\'getId\', \'isGuest\')","TypingUsers":"BdApi.findModuleByProps(\'isTyping\')"},"@discord/actions":{"ProfileActions":"BdApi.findModuleByProps(\'fetchProfile\')"},"@discord/i18n":"BdApi.findModuleByProps(\'getLocale\')","@discord/constants":"BdApi.findModuleByProps(\'API_HOST\')","@discord/contextmenu":"module const ctx = Object.assign({}, BdApi.findModuleByProps(\'openContextMenu\'), BdApi.findModuleByProps(\'MenuItem\'));\\nctx.Menu = ctx.default;\\nreturn ctx;","@discord/forms":"BdApi.findModuleByProps(\'FormItem\')","@discord/scrollbars":"BdApi.findModuleByProps(\'ScrollerAuto\')","@discord/native":"BdApi.findModuleByProps(\'requireModule\')","@discord/flux":"Object.assign({}, BdApi.findModuleByProps(\'useStateFromStores\').default, BdApi.findModuleByProps(\'useStateFromStores\'))","@discord/modal":"Object.assign({}, BdApi.findModuleByProps(\'ModalRoot\'), BdApi.findModuleByProps(\'openModal\'))","@discord/connections":"BdApi.findModuleByProps(\'get\', \'isSupported\', \'map\')","@discord/sanitize":"BdApi.findModuleByProps(\'stringify\', \'parse\', \'encode\')","@discord/icons":"BdApi.findAllModules(m => m.displayName && ~m.toString().indexOf(\'currentColor\')).reduce((icons, icon) => (icons[icon.displayName] = icon, icons), {})","@discord/classes":{"Timestamp":"BdApi.findModuleByPrototypes(\'toDate\', \'month\')","Message":"BdApi.findModuleByPrototypes(\'getReaction\', \'isSystemDM\')","User":"BdApi.findModuleByPrototypes(\'tag\')","Channel":"BdApi.findModuleByPrototypes(\'isOwner\', \'isCategory\')"}}'),j=l().resolve(__dirname,".."),x={TEMPLATES_DIR:l().resolve(__dirname,"templates"),BUILDS_PATH:l().resolve(__dirname,"..","builds"),TEMP_PATH:l().resolve(__dirname,"..","temp"),ROOT_DIR:j,RELEASE_DIR:l().resolve(__dirname,"..","releases")},D=require("module"),T=require("yargs/helpers"),O=require("yargs/yargs");var C=t.n(O);const $=[new a.ProvidePlugin({React:["react"],ReactDOM:["react-dom"]}),new a.ProgressPlugin({activeModules:!1,entries:!0,modules:!0,modulesCount:5e3,profile:!1,dependencies:!0,dependenciesCount:1e4,percentBy:null})];function E(){return{loader:"css-loader",options:{importLoaders:!0,modules:{localIdentName:b(A("info.name"),"").replace(/ /g,"")+"-[name]-[local]"}}}}function k(){return S.isDevelopment?{loader:_("babel-loader"),options:{presets:[["@babel/typescript",{esModuleInterop:!0}]],plugins:["@babel/plugin-transform-react-jsx","@babel/plugin-proposal-class-properties",["minify-dead-code-elimination"]]}}:{loader:_("@sucrase/webpack-loader"),options:{production:!0,transforms:["jsx","typescript"]}}}const I=l().resolve(__dirname,__filename.endsWith(".min.js")?"stylesheet.min":"stylesheet"),L=l().resolve(__dirname,__filename.endsWith(".min.js")?"kss.min":"kss");class F{constructor(e){if(!e||!e.hasOwnProperty("info"))throw new SyntaxError("An invalid config object was provided.");this.config=new Map,this.rawConfig=e;for(const n in e.info)this.config.set(n,e.info[n])}toString(){let e="/**";for(const[n,t]of this.config)switch(n){case"name":e+=`\n * @name ${t.replace(/ /g,"")}`;break;case"authors":e+=`\n * @author ${t.map((e=>e.name)).join(", ")}`;break;case"github_raw":e+=`\n * @updateUrl ${t}`;break;case"github":e+=`\n * @source ${t}`;break;default:e+=`\n * @${n} ${t}`}return e+"\n */"}[Symbol.iterator](){let e=-1;const n=Array.from(this.config);return{next:()=>(e++,{value:n[e],done:e>=n.length}),[Symbol.toStringTag]:"Meta Iterator"}}}const N='\n# {{name}}\n\n> {{description}}\n<hr/>\n{{contributors}}\n{{previews}}\n<span>Made with <img src="https://discord.com/assets/0483f2b648dcc986d01385062052ae1c.svg" width="15" /> by <a href="https://github.com/Kyza/bdbuilder">BDBuilder</a></span>\n'.trim();class R{constructor(e){this.config=e}get contributors(){const e=this.config.build.release.contributors;return Array.isArray(e)&&previews.length?S.format("\n# Contributors\n<table>\n<tr>\n    {{contributors}}\n</tr>\n</table>\n",{contributors:e.map((e=>S.format('\n<td align="center">\n    <img src="{{github}}.png" width="25" /><br/>\n    <a href="{{github}}"><strong>{{name}}</strong></a>\n</td>\n',e))).join("\n")})+"<br/>":""}get previews(){const e=this.config.build.release.previews;return Array.isArray(e)&&e.length?S.format("\n# Previews\n{{previews}}\n",{previews:e.map((e=>S.format("\n## {{name}}\n![image]({{src}})\n",{name:e.name,src:this.makeSrcLink(e)}))).join("<br/>\n")})+"<br/>":""}makeSrcLink(e){return this.config.build.release.public?S.resolveRawGithub(this.config.info.name,`src/${e.src}`):`data:image/${l().extname(e.src).slice(1)};base64,${o().readFileSync(l().resolve(S.getPath(),e.src)).toString("base64")}`}toString(){let e=N;return e=S.format(e,this.config.info),e=S.format(e,{contributors:this.contributors}),e=S.format(e,{previews:this.previews}),e}}const U=['class StyleLoader {\n        static styles = "";\n        static element = null;\n\n        static append(module, css) {\n            this.styles += `/* ${module} */\\n${css}`;\n        }\n\n        static inject(name = config.info.name) {\n            if(this.element) this.element.remove();\n            this.element = document.head.appendChild(Object.assign(document.createElement("style"), {id: name, textContent: this.styles}));\n        }\n\n        static remove() {\n            if (this.element) {\n                this.element.remove();\n                this.element = null;\n            }\n        }\n    }',`\n        function ___createMemoize___(instance, name, value) {\n            value = value();\n            Object.defineProperty(instance, name, {\n                value,\n                configurable: true\n            });\n\n            return value;\n        };\n        const Modules = {\n        ${Object.keys(w).reduce(((e,n)=>{if("string"==typeof w[n]){const t=w[n].startsWith("module");e.push(`get '${n}'() {return ___createMemoize___(this, '${n}', ${t?`() => {${w[n].slice("module".length+1)}}`:`() => ${w[n]}`})}`)}else e.push(`'${n}': {${Object.keys(w[n]).map((e=>`get '${e=e.trim()}'() {return ___createMemoize___(this, '${e}', ${w[n][e].startsWith("module")?`() => {${w[n][e].slice("module".length+1)}}`:`() => ${w[n][e]}`})}`)).join(",\n")}}`);return e}),[]).join(",\n")}\n    };\n`];console.log("Starting Compilation.");const{argv:q}=C()((0,T.hideBin)(process.argv));S.init(q.plugin||q.theme,q),(0,r.config)(),o().ensureDirSync(l().join(__dirname,"..","releases")),o().ensureDirSync(l().join(__dirname,"..","plugins")),o().ensureDirSync(l().join(__dirname,"..","builds")),o().ensureDirSync(l().join(__dirname,"..","temp"));const G=S.getAddonConfig();if(!~Object.keys(q).indexOf("plugin"))throw new Error("Themes loader is not implemented yet.");{const e={mode:"production",target:"node",entry:S.getPath(),output:{clean:!0,library:"LibraryPluginHack",libraryTarget:"commonjs2",filename:S.getAddonConfig("main")||"index.js",path:x.TEMP_PATH},watch:S.shouldWatch,watchOptions:{followSymlinks:!0},plugins:$,externals:function(){const e=S.getPath();return[{react:"var BdApi.React","react-dom":"var BdApi.ReactDOM","@zlibrary":"var PluginApi","@zlibrary/discord":"var PluginApi.DiscordModules","@zlibrary/plugin":"var BasePlugin",https:'var require("https")',lodash:"var window._","betterdiscord/api":"var require('betterdiscord/bdapi')",styles:"var StyleLoader",...Object.keys(w).reduce(((e,n)=>(e[n]=["var Modules",n],e)),{})},function({context:n,request:t},r){if(n===x.ROOT_DIR)return S.startTime=S.nanoseconds(),r();const i=S.getBuilderConfig(),s=l().resolve(e,"node_modules");if(o().existsSync(s)&&o().existsSync(l().join(s,t)))return r();const a=l().join(n,t);try{if(o().lstatSync(a).isDirectory()&&o().readdirSync(a).some((e=>e.startsWith("index."))))return r()}catch{}try{if(o().readdirSync(l().join(a,"..")).some((e=>e.startsWith(l().basename(a)))))return r()}catch{}try{if(Object.keys(b(i.build.resolve.alias,{})).some((e=>t.startsWith(e))))return r()}catch{}if(~D.builtinModules.indexOf(t))return r(null,"commonjs2 "+t);try{if(Object.keys(i.resolve.alias).some((e=>"$"!==e.charAt(e.length-1)&&t.startsWith(e))))return r()}catch{}throw new Error("Could not resolve depenency: "+t)}]}(),module:{rules:[{test:/\.css$/i,use:[I,E,L]},{test:/\.s[ac]ss$/i,use:[I,E,L,"sass-loader"]},{test:/\.styl$/i,use:[I,E,L,"stylus-loader"]},{test:/\.less$/i,use:[I,E,L,"less-loader"]},{test:/\.m?(j|t)sx?$/i,exclude:/node_modules/,use:k()},{test:/\.html$/i,exclude:/node_modules/,use:["raw-loader"]},{test:/\.coffee?$/i,exclude:/node_modules/,use:[k(),"coffee-loader"]}]},resolve:function(){const e=b(A("build.aliases"),{});return{extensions:[".js",".mjs",".jsx",".ts",".tsx",".coffee",".css",".scss",".sass",".less",".styl",".html",".json"],alias:Object.keys(e).reduce(((n,t)=>(n[t]=l().resolve(S.getPath(),e[t]),n)),{common:l().resolve(__dirname,"..","common")})}}(),optimization:p};S.setBuiltConfig(e),d()(e,((e,n)=>{const{build:t,...r}=S.getAddonConfig();if(e)return console.error((e.stack||e)+"\n"),void(e.details&&console.error(e.details+"\n"));if(n.hasErrors()){const e=n.toJson();for(const n of e.errors)console.log(n.message+"\n")}if(n.hasWarnings()){const e=n.toJson();for(const n of e.warnings)console.log(n.message+"\n")}if(e||n.hasErrors())return console.log(`Failed to build after ${Math.round((S.nanoseconds()-S.startTime)/1e3).toLocaleString()}s.`);o().ensureDirSync(x.TEMP_PATH);const i=new F(r),s=`${r.info.name.replace(/ /g,"")}.plugin.js`,a=l().join(x.TEMP_PATH,r.main||"index.js"),d=l().join(x.BUILDS_PATH,s);try{o().unlinkSync(d)}catch(e){console.log("Failed to remove old file:\n",e)}o().ensureFileSync(a);let c=o().readFileSync(a,"utf-8");const p=c.split("\n");if(p.splice(2,0,U.join("\n")),c=p.join("\n"),G.build.zlibrary?c=`${i}\n${S.format('\n/*@cc_on\n@if (@_jscript)\n    \n    // Offer to self-install for clueless users that try to run this directly.\n    var shell = WScript.CreateObject("WScript.Shell");\n    var fs = new ActiveXObject("Scripting.FileSystemObject");\n    var pathPlugins = shell.ExpandEnvironmentStrings("%APPDATA%BetterDiscordplugins");\n    var pathSelf = WScript.ScriptFullName;\n    // Put the user at ease by addressing them in the first person\n    shell.Popup("It looks like you\'ve mistakenly tried to run me directly. \n(Don\'t do that!)", 0, "I\'m a plugin for BetterDiscord", 0x30);\n    if (fs.GetParentFolderName(pathSelf) === fs.GetAbsolutePathName(pathPlugins)) {\n        shell.Popup("I\'m in the correct folder already.", 0, "I\'m already installed", 0x40);\n    } else if (!fs.FolderExists(pathPlugins)) {\n        shell.Popup("I can\'t find the BetterDiscord plugins folder.\nAre you sure it\'s even installed?", 0, "Can\'t install myself", 0x10);\n    } else if (shell.Popup("Should I copy myself to BetterDiscord\'s plugins folder for you?", 0, "Do you need some help?", 0x34) === 6) {\n        fs.CopyFile(pathSelf, fs.BuildPath(pathPlugins, fs.GetFileName(pathSelf)), true);\n        // Show the user where to put plugins in the future\n        shell.Exec("explorer " + pathPlugins);\n        shell.Popup("I\'m installed!", 0, "Successfully installed", 0x40);\n    }\n    WScript.Quit();\n@else@*/\n\n/* Generated Code */\n\nconst config = {{pluginConfig}};\n\nfunction buildPlugin([BasePlugin, PluginApi]) {\n    const module = {exports: {}};\n\n    {{builtCode}}\n\n    const PluginExports = module.exports.LibraryPluginHack;\n    return PluginExports?.__esModule ? PluginExports.default : PluginExports;\n}\n\nmodule.exports = window.hasOwnProperty("ZeresPluginLibrary")\n    ? buildPlugin(window.ZeresPluginLibrary.buildPlugin(config))\n    : class {\n        getName() {return config.info.name;}\n        getAuthor() {return config.info.authors.map(a => a.name).join(", ");}\n        getDescription() {return `${config.info.description}. __**ZeresPluginLibrary was not found! This plugin will not work!**__`;}\n        getVersion() {return config.info.version;}\n        load() {\n            BdApi.showConfirmationModal(\n                "Library plugin is needed", \n                [`The library plugin needed for ${config.info.name} is missing. Please click Download to install it.`], \n                {\n                    confirmText: "Download",\n                    cancelText: "Cancel",\n                    onConfirm: () => {\n                        require("request").get("https://rauenzi.github.io/BDPluginLibrary/release/0PluginLibrary.plugin.js", async (error, response, body) => {\n                            if (error) return require("electron").shell.openExternal("https://betterdiscord.net/ghdl?url=https://raw.githubusercontent.com/rauenzi/BDPluginLibrary/master/release/0PluginLibrary.plugin.js");\n                            await new Promise(r => require("fs").writeFile(require("path").join(BdApi.Plugins.folder, "0PluginLibrary.plugin.js"), body, r));\n                        });\n                    }\n                }\n            );\n        }\n        start() {}\n        stop() {}\n    };\n\n/*@end@*/',{pluginConfig:JSON.stringify(G,null,"\t"),builtCode:c})}`:(c=c.replace("module.exports.LibraryPluginHack = __webpack_exports__","module.exports = __webpack_exports__.default ?? __webpack_exports__"),c=`${i}\n${c}`),c=(0,u.js)(c,{indent_with_tabs:!0}).replace(/\n{2,}/g,"\n"),o().writeFileSync(d,c),console.log(`Built in ${Math.round((S.nanoseconds()-S.startTime)/1e3).toLocaleString()}s.`),q.release)try{const e=A("build.release"),n=A("info");if("object"!=typeof e)throw new Error("Invalid release configuration");const t=b(e.public?l().join(process.env.RELEASE_FOLDER,n.name):void 0,l().join(x.RELEASE_DIR,n.name));o().existsSync(t)?o().emptyDirSync(t):o().mkdirSync(t),b(e.readme,!0)&&o().writeFileSync(l().join(t,"README.md"),new R(G).toString(),"utf8"),b(e.source,!0)&&o().copy(S.getPath(),l().join(t,"src"),{recursive:!0,filter:e=>e.indexOf("node_modules")<0}),o().writeFileSync(l().join(t,s),c)}catch(e){console.error("Release build failed!\n",e)}else G.build.copy&&(o().ensureDirSync(process.env.BDFOLDER),o().writeFileSync(l().resolve(l().join(process.env.BDFOLDER,s)),c));if(G.build.production)try{o().emptyDirSync(x.TEMP_PATH),o().rmdirSync(x.TEMP_PATH,{recursive:!0})}catch(e){console.error("Failed to remove tmp path:",e)}}))}},79:e=>{function n(e){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}n.keys=()=>[],n.resolve=n,n.id=79,e.exports=n}},n={};function t(r){var i=n[r];if(void 0!==i)return i.exports;var o=n[r]={exports:{}};return e[r](o,o.exports,t),o.exports}t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),t.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r=t(277);module.exports=r})();